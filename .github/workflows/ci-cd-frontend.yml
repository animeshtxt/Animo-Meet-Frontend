name: Deploy React Frontend

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      # 1. Backup .env
      - name: Backup .env
        run: |
          # Use -p to ensure the directory exists, and use $RUNNER_TEMP
          if [ -f .env ]; then
            cp .env $RUNNER_TEMP/.env_backup
          fi
      # 2. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 3. Restore .env
      - name: Restore .env
        run: |
          if [ -f $RUNNER_TEMP/.env_backup ]; then
            mv $RUNNER_TEMP/.env_backup .env
          fi

      # 4. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      # 3. Install Dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Build the App
      - name: Build
        run: npm run build

      # 5. Deploy to Nginx directory (Local copy since self-hosted)
      # - name: Copy build files to Nginx directory
      #   run: |
      #     sudo rm -rf /var/www/animo-meet-frontend/*
      #     sudo cp -r dist/* /var/www/animo-meet-frontend/
      #     sudo chown -R www-data:www-data /var/www/animo-meet-frontend
      #     sudo chmod -R 755 /var/www/animo-meet-frontend

    # 6. Optional: Restart Nginx (Usually not needed for static files, but good for cache clearing)
    # - name: Reload Nginx
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: ${{ secrets.EC2_HOST }}
    #     username: ${{ secrets.EC2_USERNAME }}
    #     key: ${{ secrets.EC2_SSH_KEY }}
    #     script: sudo systemctl reload nginx
